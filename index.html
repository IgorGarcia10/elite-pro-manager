<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Pro Manager - FÃºria FS</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #000; color: #fff; margin: 0; overflow-x: hidden; touch-action: manipulation; }
        .tab-active { color: #38bdf8; border-bottom: 3px solid #38bdf8; }
        .num-font { font-family: 'Courier New', Courier, monospace; }
        .glass { background: rgba(15, 15, 15, 0.98); border: 1px solid rgba(255,255,255,0.05); }
        .btn-cobalt { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        .btn-red { background: linear-gradient(135deg, #991b1b 0%, #ef4444 100%); box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }
        .animate-pulse-red { animation: pulse 1.5s infinite; color: #ff4d4d; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        input { font-size: 16px !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // LINK ATUALIZADO DA SUA NOVA IMPLANTAÃ‡ÃƒO
        const API_URL = "https://script.google.com/macros/s/AKfycbzF60aNU3ZnahsFLWWH39oUgHzrH0xzwLg_pfmNSIMbO_fsDhNEIbhFoeIogNSUS7FvGw/exec";

        const App = () => {
            const [isAuthorized, setIsAuthorized] = useState(localStorage.getItem('auth_elite') === 'true');
            const [pinInput, setPinInput] = useState("");
            const [loginError, setLoginError] = useState(false);

            const [activeTab, setActiveTab] = useState('match');
            const [athletes, setAthletes] = useState([]);
            const [rankingData, setRankingData] = useState([]);
            const [lastGames, setLastGames] = useState([]);
            const [loading, setLoading] = useState(false);
            
            const [teamA, setTeamA] = useState("FURIA FS");
            const [teamB, setTeamB] = useState("TIME B");
            const [scoreA, setScoreA] = useState(0);
            const [scoreB, setScoreB] = useState(0);
            const [foulsA, setFoulsA] = useState(0);
            const [foulsB, setFoulsB] = useState(0);
            const [matchStats, setMatchStats] = useState({});
            const [timeLeft, setTimeLeft] = useState(1200);
            const [isRunning, setIsRunning] = useState(false);
            const [isEditingTime, setIsEditingTime] = useState(false);

            // Carrega dados bÃ¡sicos apÃ³s login
            useEffect(() => {
                if(isAuthorized) {
                    setLoading(true);
                    fetch(API_URL).then(res => res.json()).then(data => {
                        if(Array.isArray(data)) {
                            setAthletes(data.map((n, i) => ({ id: i.toString(), name: n })));
                        }
                        setLoading(false);
                    }).catch(() => setLoading(false));
                }
            }, [isAuthorized]);

            // Carrega ranking e histÃ³rico conforme navegaÃ§Ã£o
            useEffect(() => {
                if(isAuthorized && (activeTab === 'ranking' || activeTab === 'placares')) {
                    setLoading(true);
                    const action = activeTab === 'ranking' ? 'getRanking' : 'getResults';
                    fetch(`${API_URL}?action=${action}`).then(res => res.json()).then(data => {
                        activeTab === 'ranking' ? setRankingData(data) : setLastGames(data);
                        setLoading(false);
                    });
                }
            }, [activeTab, isAuthorized]);

            // Timer do jogo
            useEffect(() => {
                let interval;
                if (isRunning && timeLeft > 0) interval = setInterval(() => setTimeLeft(p => p - 1), 1000);
                return () => clearInterval(interval);
            }, [isRunning, timeLeft]);

            // LOGIN SEGURO: VALIDA NO GOOGLE SCRIPT
            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}?action=checkLogin&pin=${pinInput}`);
                    const data = await response.json();
                    
                    if(data.auth === true) {
                        setIsAuthorized(true);
                        localStorage.setItem('auth_elite', 'true');
                    } else {
                        setLoginError(true);
                        setPinInput("");
                        setTimeout(() => setLoginError(false), 2000);
                    }
                } catch (err) {
                    alert("Erro ao conectar ao servidor. Verifique o link da API.");
                }
                setLoading(false);
            };

            const formatTime = (s) => {
                const m = Math.floor(s / 60);
                const seg = s % 60;
                return `${m.toString().padStart(2, '0')}:${seg.toString().padStart(2, '0')}`;
            };

            const formatDate = (isoString) => {
                try {
                    const d = new Date(isoString);
                    if (isNaN(d.getTime())) return isoString; 
                    return d.toLocaleString('pt-BR', { 
                        timeZone: 'America/Sao_Paulo',
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    }).replace(',', ' -');
                } catch(e) { return isoString; }
            };

            const handleManualTime = (val) => {
                const parts = val.split(':');
                if(parts.length === 2) {
                    const total = (parseInt(parts[0]) * 60) + parseInt(parts[1]);
                    if(!isNaN(total)) setTimeLeft(total);
                }
                setIsEditingTime(false);
            };

            const updateStat = (id, type, val) => {
                setMatchStats(prev => ({
                    ...prev,
                    [id]: { ...prev[id], [type]: Math.max(0, (prev[id]?.[type] || 0) + val) }
                }));
            };

            const handleSave = async () => {
                if(!confirm("Deseja encerrar e salvar os dados?")) return;
                setLoading(true);
                const statsDetalhadas = {};
                Object.keys(matchStats).forEach(id => {
                    const ath = athletes.find(a => a.id === id);
                    if (ath) statsDetalhadas[ath.name] = { g: matchStats[id].goals || 0, a: matchStats[id].assists || 0 };
                });

                const payload = { timestamp: new Date().toISOString(), teamA, teamB, scoreA, scoreB, foulsA, foulsB, elenco: athletes.map(a => a.name), stats: statsDetalhadas };

                try {
                    await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                    alert("âœ… EstatÃ­sticas sincronizadas!");
                    setScoreA(0); setScoreB(0); setFoulsA(0); setFoulsB(0); setMatchStats({}); setTimeLeft(1200); setIsRunning(false);
                } catch (e) { alert("Erro ao salvar"); }
                setLoading(false);
            };

            if (!isAuthorized) {
                return (
                    <div className="h-screen w-full flex flex-col items-center justify-center p-6 bg-black">
                        <div className="w-full max-w-sm glass p-8 rounded-[3rem] text-center border-blue-900/20 border-2">
                            <h1 className="text-3xl font-black italic text-blue-500 mb-2 italic">ELITE PRO</h1>
                            <p className="text-neutral-500 text-[10px] uppercase tracking-[0.3em] mb-10">Controle de Acesso</p>
                            
                            <form onSubmit={handleLogin} className="space-y-6">
                                <input 
                                    type="password" 
                                    inputMode="numeric"
                                    value={pinInput}
                                    onChange={(e) => setPinInput(e.target.value)}
                                    placeholder="PIN" 
                                    className={`w-full bg-neutral-900/50 border-2 ${loginError ? 'border-red-600' : 'border-white/10'} p-6 rounded-2xl text-center text-3xl font-black tracking-[0.5em] outline-none focus:border-blue-500 transition-all`}
                                    autoFocus
                                />
                                <button type="submit" disabled={loading} className="w-full btn-cobalt text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest active:scale-95 transition-all">
                                    {loading ? 'Validando...' : 'Entrar'}
                                </button>
                                {loginError && <p className="text-red-500 text-[10px] font-black uppercase animate-bounce mt-4">PIN INCORRETO</p>}
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-24 flex flex-col items-center">
                    <nav className="w-full flex justify-around bg-neutral-900/90 backdrop-blur sticky top-0 z-50 border-b border-white/5">
                        {['match', 'roster', 'placares', 'ranking'].map(t => (
                            <button key={t} onClick={() => setActiveTab(t)} className={`py-4 px-1 text-[10px] font-black uppercase tracking-tighter ${activeTab === t ? 'tab-active' : 'text-neutral-500'}`}>
                                {t === 'match' ? 'Jogo' : t === 'roster' ? 'Jogadores' : t === 'placares' ? 'HistÃ³rico' : 'Ranking'}
                            </button>
                        ))}
                    </nav>

                    <main className="w-full max-w-[500px] p-3 space-y-4">
                        {activeTab === 'match' && (
                            <div className="space-y-4">
                                <div className="text-center py-6 glass rounded-[2.5rem]">
                                    {isEditingTime ? (
                                        <input type="text" defaultValue={formatTime(timeLeft)} onBlur={(e) => handleManualTime(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleManualTime(e.target.value)} className="bg-black text-5xl font-black text-center w-40 rounded-xl border-2 border-blue-500 outline-none p-2" autoFocus />
                                    ) : (
                                        <div onClick={() => setIsEditingTime(true)} className="text-7xl font-black num-font tabular-nums cursor-pointer tracking-tighter italic">{formatTime(timeLeft)}</div>
                                    )}
                                    <div className="flex justify-center gap-3 mt-4">
                                        <button onClick={() => setIsRunning(!isRunning)} className={`px-8 py-2 rounded-full font-black text-[10px] uppercase tracking-widest ${isRunning ? 'bg-red-600' : 'btn-cobalt text-white'}`}>{isRunning ? 'Pausar' : 'Iniciar'}</button>
                                        <button onClick={() => setTimeLeft(1200)} className="bg-neutral-800 px-8 py-2 rounded-full text-[10px] font-black uppercase">Reset</button>
                                    </div>
                                </div>

                                <div className="glass rounded-[2.5rem] p-4">
                                    <div className="flex justify-between items-start gap-1">
                                        <div className="w-[45%] text-center">
                                            <input value={teamA} onChange={e => setTeamA(e.target.value.toUpperCase())} className="bg-transparent text-lg font-black text-blue-400 w-full text-center outline-none mb-1" />
                                            <div className="text-7xl font-black my-2 leading-none italic">{scoreA}</div>
                                            <div className="flex justify-center gap-1 mb-4">
                                                <button onClick={() => setScoreA(Math.max(0,scoreA-1))} className="w-10 h-10 bg-neutral-800 rounded-lg">-</button>
                                                <button onClick={() => setScoreA(scoreA+1)} className="w-10 h-10 btn-cobalt text-white rounded-lg font-black">+</button>
                                            </div>
                                            <div className="bg-black/60 p-2 rounded-2xl border border-white/5">
                                                <div className={`text-xl font-black mb-2 ${foulsA >= 5 ? 'animate-pulse-red' : 'text-neutral-400'}`}>Faltas: {foulsA}</div>
                                                <div className="flex justify-center gap-2">
                                                    <button onClick={() => setFoulsA(Math.max(0,foulsA-1))} className="w-8 h-8 bg-neutral-800 rounded-md">-</button>
                                                    <button onClick={() => setFoulsA(foulsA+1)} className="w-8 h-8 bg-red-950/50 text-red-500 rounded-md font-bold">+</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="pt-12 font-black italic opacity-10 text-xs">VS</div>
                                        <div className="w-[45%] text-center">
                                            <input value={teamB} onChange={e => setTeamB(e.target.value.toUpperCase())} className="bg-transparent text-lg font-black text-red-400 w-full text-center outline-none mb-1" />
                                            <div className="text-7xl font-black my-2 leading-none italic text-red-100">{scoreB}</div>
                                            <div className="flex justify-center gap-1 mb-4">
                                                <button onClick={() => setScoreB(Math.max(0,scoreB-1))} className="w-10 h-10 bg-neutral-800 rounded-lg">-</button>
                                                <button onClick={() => setScoreB(scoreB+1)} className="w-10 h-10 btn-red text-white rounded-lg font-black">+</button>
                                            </div>
                                            <div className="bg-black/60 p-2 rounded-2xl border border-white/5">
                                                <div className={`text-xl font-black mb-2 ${foulsB >= 5 ? 'animate-pulse-red' : 'text-neutral-400'}`}>Faltas: {foulsB}</div>
                                                <div className="flex justify-center gap-2">
                                                    <button onClick={() => setFoulsB(Math.max(0,foulsB-1))} className="w-8 h-8 bg-neutral-800 rounded-md">-</button>
                                                    <button onClick={() => setFoulsB(foulsB+1)} className="w-8 h-8 bg-red-950/50 text-red-500 rounded-md font-bold">+</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="glass rounded-[2.5rem] p-4">
                                    <div className="flex text-[9px] font-black text-neutral-500 uppercase px-1 mb-4">
                                        <span className="w-2/5">Atleta</span>
                                        <span className="w-[30%] text-center">Gols</span>
                                        <span className="w-[30%] text-center">Assis</span>
                                    </div>
                                    <div className="space-y-4">
                                        {athletes.map(a => (
                                            <div key={a.id} className="flex items-center justify-between border-b border-white/5 pb-2">
                                                <div className="w-2/5 text-[11px] font-black truncate uppercase tracking-tight">{a.name}</div>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => updateStat(a.id, 'goals', -1)} className="w-7 h-7 bg-neutral-800 rounded-lg">-</button>
                                                    <span className="text-xs font-black w-4 text-center">{matchStats[a.id]?.goals || 0}</span>
                                                    <button onClick={() => updateStat(a.id, 'goals', 1)} className="w-7 h-7 btn-cobalt text-white rounded-lg font-black">+</button>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => updateStat(a.id, 'assists', -1)} className="w-7 h-7 bg-neutral-800 rounded-lg">-</button>
                                                    <span className="text-xs font-black w-4 text-center">{matchStats[a.id]?.assists || 0}</span>
                                                    <button onClick={() => updateStat(a.id, 'assists', 1)} className="w-7 h-7 btn-red text-white rounded-lg font-black">+</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={handleSave} className="w-full mt-8 bg-white text-black font-black py-5 rounded-2xl uppercase text-[11px] tracking-[0.2em] active:scale-95 transition-all">Finalizar Jogo</button>
                                    <button onClick={() => { localStorage.removeItem('auth_elite'); window.location.reload(); }} className="w-full mt-4 text-[9px] font-black text-neutral-700 uppercase tracking-[0.2em] hover:text-white transition-colors">Encerrar SessÃ£o</button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'ranking' && (
                            <div className="glass p-5 rounded-[2.5rem]">
                                <h2 className="text-xl font-black italic text-blue-400 mb-6 uppercase text-center">Ranking</h2>
                                {rankingData.length > 1 ? Object.values(rankingData.slice(1).reduce((acc, row) => {
                                    const [nome, g, a] = row;
                                    if(!acc[nome]) acc[nome] = {nome, g: 0, a: 0};
                                    acc[nome].g += Number(g); acc[nome].a += Number(a);
                                    return acc;
                                }, {})).sort((a,b) => b.g - a.g).map((at, i) => (
                                    <div key={i} className={`flex items-center justify-between p-4 mb-2 rounded-2xl border ${i === 0 ? 'bg-yellow-500/10 border-yellow-500/50' : i === 1 ? 'bg-slate-300/10 border-slate-300/50' : i === 2 ? 'bg-amber-700/10 border-amber-700/50' : 'bg-white/5 border-white/5'}`}>
                                        <div className="w-1/2 text-[11px] font-black uppercase truncate flex items-center gap-2">{i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : ''} {at.nome}</div>
                                        <div className="flex gap-4">
                                            <div className="text-center"><div className="text-[8px] font-bold text-blue-400 uppercase">Gols</div><div className="text-base font-black italic">{at.g}</div></div>
                                            <div className="text-center"><div className="text-[8px] font-bold text-red-400 uppercase">Assis</div><div className="text-base font-black italic">{at.a}</div></div>
                                        </div>
                                    </div>
                                )) : <div className="text-center py-10 opacity-20 uppercase font-black text-xs">Carregando...</div>}
                            </div>
                        )}

                        {activeTab === 'placares' && (
                            <div className="space-y-4">
                                <h2 className="text-xl font-black italic text-blue-400 mb-4 uppercase text-center">HistÃ³rico</h2>
                                {lastGames.length > 1 ? lastGames.slice(1).reverse().map((g, i) => (
                                    <div key={i} className="glass p-5 rounded-[2rem]">
                                        <div className="text-[9px] text-center text-neutral-500 mb-2 font-black tracking-widest">{formatDate(g[0])}</div>
                                        <div className="flex justify-between items-center px-1">
                                            <div className="text-center w-1/3">
                                                <div className="text-[10px] font-black text-blue-400 mb-1 truncate">{g[1]}</div>
                                                <div className="text-4xl font-black italic leading-none">{g[2]}</div>
                                                <div className="text-[8px] font-bold text-neutral-500 uppercase mt-2">Faltas: {g[3] || 0}</div>
                                            </div>
                                            <div className="text-[10px] font-black opacity-10 italic">VS</div>
                                            <div className="text-center w-1/3">
                                                <div className="text-[10px] font-black text-red-400 mb-1 truncate">{g[6]}</div>
                                                <div className="text-4xl font-black italic leading-none text-red-100">{g[5]}</div>
                                                <div className="text-[8px] font-bold text-neutral-500 uppercase mt-2">Faltas: {g[4] || 0}</div>
                                            </div>
                                        </div>
                                    </div>
                                )) : <div className="text-center py-20 opacity-20 uppercase font-black text-xs">Sem registros.</div>}
                            </div>
                        )}

                        {activeTab === 'roster' && (
                            <div className="glass p-6 rounded-[2.5rem]">
                                <h2 className="text-xl font-black italic text-blue-400 mb-6 uppercase text-center">Jogadores</h2>
                                <div className="flex gap-2 mb-6">
                                    <input id="newP" placeholder="NOME DO JOGADOR" className="flex-1 bg-black border border-white/10 p-4 rounded-xl text-[10px] font-black outline-none focus:border-blue-500 uppercase" />
                                    <button onClick={() => {
                                        const n = document.getElementById('newP').value;
                                        if(n) { setAthletes([...athletes, {id: Date.now().toString(), name: n.toUpperCase()}]); document.getElementById('newP').value=''; }
                                    }} className="btn-cobalt text-white px-6 rounded-xl font-black text-xl">+</button>
                                </div>
                                <div className="max-h-[300px] overflow-y-auto pr-2 space-y-2">
                                    {athletes.map(a => (
                                        <div key={a.id} className="p-3 bg-white/5 rounded-xl border border-white/5 text-[10px] font-black flex justify-between items-center uppercase">
                                            {a.name}
                                            <button onClick={()=>setAthletes(athletes.filter(x=>x.id!==a.id))} className="text-red-900 font-bold px-2 tracking-tighter italic">REMOVER</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {loading && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100]">
                            <div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
